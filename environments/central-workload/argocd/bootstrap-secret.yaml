# ArgoCD Repository SSH Secret - "All From Code" Approach
# This creates the SSH secret using External Secrets Operator
# 
# Prerequisites:
# 1. Store SSH private key in AWS Secrets Manager
# 2. External Secrets Operator deployed in cluster
# 3. Proper IRSA for External Secrets

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: argocd-repo-secret
  namespace: argo
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secretsmanager
    kind: SecretStore
  target:
    name: repo-mekorot-helm
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          argocd.argoproj.io/secret-type: repository
      data:
        type: git
        url: git@github.com:barzviely/mekorot-helm.git
        name: mekorot-helm
        sshPrivateKey: "{{ .sshPrivateKey }}"
  data:
  - secretKey: sshPrivateKey
    remoteRef:
      key: argocd/ssh-private-key
      property: private-key

---
# SecretStore for AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secretsmanager
  namespace: argo
spec:
  provider:
    aws:
      service: SecretsManager
      region: il-central-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
